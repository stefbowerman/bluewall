// Generated by CoffeeScript 1.6.3
(function() {
  var ScrollAjax, TopScroller, attachImageErrorHandler;

  ScrollAjax = function($el) {
    var $appendEl, $doc, $loader, $streamEnd, $win, appendMedia, baseURL, getNextPageContent, isComplete, isLoading, page, scrollDistance, self;
    self = this;
    $appendEl = $el;
    $loader = $('#loader');
    $streamEnd = $('#stream-end');
    $win = $(window);
    $doc = $(document);
    baseURL = '/ajax/media.php?page=';
    page = 1;
    scrollDistance = 0.65;
    isLoading = false;
    isComplete = false;
    this.baseURL = baseURL;
    this.getPage = function() {
      return page;
    };
    this.nextPage = function() {
      page++;
      return this;
    };
    appendMedia = function(html, index, collection) {
      var $html;
      $html = $(html);
      $appendEl.append($html);
      if (index + 1 === collection.length) {
        return isLoading = false;
      }
    };
    getNextPageContent = function(callback) {
      isLoading = true;
      self.nextPage();
      $loader.fadeIn('fast');
      return $.ajax({
        url: self.baseURL + page
      }).done(function(data) {
        if (data.length) {
          $loader.fadeOut('600', function() {
            var i, _i, _ref, _results;
            _results = [];
            for (i = _i = 0, _ref = data.length; _i < _ref; i = _i += 1) {
              _results.push(appendMedia(data[i]['html'], i, data));
            }
            return _results;
          });
          if (data.length < 10) {
            isComplete = true;
            return $loader.fadeOut({
              duration: '600',
              always: function() {
                return $streamEnd.fadeIn();
              }
            });
          }
        } else {
          isComplete = true;
          return $loader.fadeOut({
            duration: '600',
            always: function() {
              return $streamEnd.fadeIn();
            }
          });
        }
      }).fail(function() {
        return console.log("error getting page " + page);
      });
    };
    $win.on('scroll', function() {
      if (isLoading === false && isComplete === false && ($win.scrollTop() / $doc.height() > scrollDistance)) {
        return getNextPageContent();
      }
    });
    return this;
  };

  TopScroller = function() {
    var $el, $win, checkPosition, checking;
    $win = $(window);
    $el = $('.scroll-me-up');
    checking = false;
    checkPosition = function() {
      checking = true;
      if ($win.scrollTop() > 5000) {
        $el.removeClass('off-stage');
      } else {
        $el.addClass('off-stage');
      }
      return setTimeout(function() {
        return checking = false;
      }, 300);
    };
    $win.on('scroll', function() {
      if (checking === false) {
        checkPosition();
      }
      return false;
    });
    return $el.on('click', 'a', function() {
      checking = true;
      $el.addClass('off-stage');
      return $('body').animate({
        scrollTop: 0
      }, 300, function() {
        return checking = false;
      });
    });
  };

  attachImageErrorHandler = function() {
    return $('img').each(function(i) {
      var $img, img;
      img = this;
      $img = $(img);
      if (!$img.data('imageErrorHandler:attached')) {
        return img.onerror = function() {
          var $parentPost;
          $parentPost = $img.parents('.post');
          $parentPost.remove();
          return $img.data('imageErrorHandler:attached', true);
        };
      }
    });
  };

  $(window).ajaxComplete(function() {
    return attachImageErrorHandler();
  });

  $(function() {
    attachImageErrorHandler();
    this.scrollAjax = new ScrollAjax($('#content-stream'));
    new TopScroller();
    $('#content-stream, header').addClass('opacity-hide');
    if ($('html').hasClass('csstransitions')) {
      return setTimeout(function() {
        return $('#content-stream, header').addClass('opacity-trans-show');
      }, 300);
    } else {
      return $('#content-stream, header').css({
        opacity: 0
      }, setTimeout(function() {
        return $('#content-stream, header').animate({
          opacity: 1
        }, 1200, function() {
          return $('#content-stream, header').removeClass('opacity-hide');
        });
      }, 300));
    }
  });

}).call(this);
